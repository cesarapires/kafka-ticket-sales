#!/bin/sh

# Função para verificar se um contêiner Docker está em execução
is_container_running() {
  docker ps -q -f name=kafka-ticket-sales-app
}

# Função para verificar se uma imagem Docker existe
has_image() {
  docker image inspect kafka-ticket-sales > /dev/null 2>&1
}

if ! has_image; then
  echo "Creating new image..."
  docker build -t kafka-ticket-sales .
else
  echo "The image was found"
fi

# Verifica se o contêiner de teste já está em execução
if [ -n "$(is_container_running)" ]; then
  echo "The test container is already running."
else
  echo "Starting the test container..."
  docker compose up -d
fi

# Executa os testes unitários no contêiner
docker compose exec -it -T app ./mvnw test

# Captura o código de saída do comando de teste
TEST_RESULT=$?

# Verifica se os testes falharam e aborta o commit, se necessário
if [ $TEST_RESULT -ne 0 ]; then
  echo "Unit tests failed. Aborting the commit."
  exit 1
fi

# Se os testes passarem, permite o commit
exit 0
